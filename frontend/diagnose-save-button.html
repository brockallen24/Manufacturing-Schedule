<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Save Button Diagnostic - Manufacturing Schedule</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        .test-section {
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 20px;
            margin: 20px 0;
        }
        .test-section h3 {
            margin-top: 0;
            color: #007bff;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 10px 10px 0;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .diagnostic-button {
            background: #2196F3;
        }
        .diagnostic-button:hover:not(:disabled) {
            background: #0b7dda;
        }
        #results {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            display: none;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            display: block;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            display: block;
        }
        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            display: block;
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
            display: block;
        }
        .checklist {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
        }
        .checklist-item {
            padding: 8px 0;
            border-bottom: 1px solid #dee2e6;
        }
        .checklist-item:last-child {
            border-bottom: none;
        }
        .check-icon {
            color: #28a745;
            margin-right: 10px;
        }
        .x-icon {
            color: #dc3545;
            margin-right: 10px;
        }
        code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Save Button Diagnostic Tool</h1>
        <p class="subtitle">Comprehensive testing for why the save button isn't working</p>

        <div class="test-section">
            <h3>Test 1: Check Backend API Connection</h3>
            <p>First, let's verify the Heroku backend is responding</p>
            <button id="testBackend" class="diagnostic-button">Test Backend Connection</button>
        </div>

        <div class="test-section">
            <h3>Test 2: Check Airtable Table Structure</h3>
            <p>Let's see what fields currently exist in your Airtable "Jobs" table</p>
            <button id="checkFields" class="diagnostic-button">Check Airtable Fields</button>
        </div>

        <div class="test-section">
            <h3>Test 3: Try Actual Save Operation</h3>
            <p>Attempt to save a test job (exactly like your app would)</p>
            <button id="testSave">Simulate Save Button Click</button>
        </div>

        <div class="test-section">
            <h3>Test 4: Frontend JavaScript Check</h3>
            <p>Verify the frontend code can load properly</p>
            <button id="testFrontend" class="diagnostic-button">Check Frontend Code</button>
        </div>

        <div id="results"></div>

        <div class="test-section" style="margin-top: 30px;">
            <h3>üìã Quick Checklist - Common Issues</h3>
            <div class="checklist">
                <div class="checklist-item">
                    <strong>Issue:</strong> Button doesn't respond when clicked
                    <br><strong>Cause:</strong> JavaScript error preventing form submission
                    <br><strong>Fix:</strong> Check browser console (F12) for red errors
                </div>
                <div class="checklist-item">
                    <strong>Issue:</strong> Button shows error message immediately
                    <br><strong>Cause:</strong> Airtable table missing required fields
                    <br><strong>Fix:</strong> Add 13 required fields (see AIRTABLE_FIELD_SETUP.md)
                </div>
                <div class="checklist-item">
                    <strong>Issue:</strong> Button appears to work but data doesn't save
                    <br><strong>Cause:</strong> Backend API error or network issue
                    <br><strong>Fix:</strong> Check Heroku logs and API connection
                </div>
                <div class="checklist-item">
                    <strong>Issue:</strong> Form validation fails
                    <br><strong>Cause:</strong> Required fields not filled in
                    <br><strong>Fix:</strong> Fill in all fields marked with *
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'https://manufacturing-schedule-7575b6f1cdb3.herokuapp.com/api';
        const resultsDiv = document.getElementById('results');

        function showResult(message, type = 'info') {
            resultsDiv.className = type;
            resultsDiv.textContent = message;
            resultsDiv.style.display = 'block';
        }

        // Test 1: Backend Connection
        document.getElementById('testBackend').addEventListener('click', async () => {
            showResult('Testing backend connection...', 'info');

            try {
                const response = await fetch(`${API_BASE_URL}/health`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    const data = await response.json();
                    showResult(
                        `‚úÖ BACKEND IS WORKING!\n\n` +
                        `Response: ${JSON.stringify(data, null, 2)}\n\n` +
                        `The Heroku backend is online and responding.\n` +
                        `This means the backend is NOT the problem.`,
                        'success'
                    );
                } else {
                    showResult(
                        `‚ùå BACKEND ERROR\n\n` +
                        `Status: ${response.status}\n` +
                        `The backend is online but returned an error.\n\n` +
                        `This is unusual. Check Heroku logs.`,
                        'error'
                    );
                }
            } catch (error) {
                showResult(
                    `‚ùå BACKEND NOT RESPONDING\n\n` +
                    `Error: ${error.message}\n\n` +
                    `The Heroku backend is either:\n` +
                    `- Not running (dyno is off)\n` +
                    `- Wrong URL in code\n` +
                    `- Network connectivity issue\n\n` +
                    `Current URL: ${API_BASE_URL}`,
                    'error'
                );
            }
        });

        // Test 2: Check Fields
        document.getElementById('checkFields').addEventListener('click', async () => {
            showResult('Checking Airtable table structure...', 'info');

            try {
                const response = await fetch(`${API_BASE_URL}/jobs`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response.ok) {
                    throw new Error(`API returned status ${response.status}`);
                }

                const data = await response.json();

                if (!data.jobs || data.jobs.length === 0) {
                    showResult(
                        `‚ö†Ô∏è TABLE IS EMPTY\n\n` +
                        `The "Jobs" table exists but has no records.\n\n` +
                        `This means we can't check the field structure yet.\n` +
                        `Try Test 3 to see what happens when we try to save.`,
                        'warning'
                    );
                    return;
                }

                // Analyze fields
                const firstJob = data.jobs[0];
                const existingFields = Object.keys(firstJob).filter(f => f !== 'id');

                const requiredFields = [
                    'type', 'machine', 'jobName', 'workOrder', 'numParts',
                    'cycleTime', 'numCavities', 'material', 'totalMaterial',
                    'totalHours', 'dueDate', 'percentComplete'
                ];

                const missingFields = requiredFields.filter(f => !existingFields.includes(f));

                let message = `üìä AIRTABLE TABLE ANALYSIS\n\n`;
                message += `Found ${data.jobs.length} existing record(s)\n\n`;
                message += `Current fields in table:\n`;
                existingFields.forEach(f => message += `  ‚úì ${f}\n`);
                message += `\n`;

                if (missingFields.length > 0) {
                    message += `‚ùå MISSING REQUIRED FIELDS (${missingFields.length}):\n`;
                    missingFields.forEach(f => message += `  ‚úó ${f}\n`);
                    message += `\n`;
                    message += `THIS IS WHY SAVE IS FAILING!\n\n`;
                    message += `SOLUTION:\n`;
                    message += `1. Go to: https://airtable.com/appYjsKjwhJbkwFv5\n`;
                    message += `2. Open "Jobs" table\n`;
                    message += `3. Add the ${missingFields.length} missing fields\n`;
                    message += `4. Follow: AIRTABLE_FIELD_SETUP.md for details`;
                    showResult(message, 'error');
                } else {
                    message += `‚úÖ ALL REQUIRED FIELDS PRESENT!\n\n`;
                    message += `Your Airtable table structure is correct.\n`;
                    message += `The field issue is NOT the problem.\n\n`;
                    message += `Proceed to Test 3 to find the real issue.`;
                    showResult(message, 'success');
                }

            } catch (error) {
                showResult(
                    `‚ùå FAILED TO CHECK FIELDS\n\n` +
                    `Error: ${error.message}\n\n` +
                    `Could not retrieve data from Airtable.\n` +
                    `Check backend connection first (Test 1).`,
                    'error'
                );
            }
        });

        // Test 3: Simulate Save
        document.getElementById('testSave').addEventListener('click', async () => {
            showResult('Simulating save operation (like clicking Save Job button)...', 'info');

            const testJobData = {
                id: `TEST-${Date.now()}`,
                type: 'job',
                machine: '22',
                jobName: 'Test Job - Diagnostic',
                workOrder: 'WO-DIAG-001',
                numParts: 100,
                cycleTime: 1.5,
                numCavities: 2,
                material: 'PLA',
                totalMaterial: 150.5,
                totalHours: 2.5,
                dueDate: '2026-01-20',
                percentComplete: 0
            };

            let message = `üì§ ATTEMPTING TO SAVE TEST JOB\n\n`;
            message += `Job data being sent:\n${JSON.stringify(testJobData, null, 2)}\n\n`;
            message += `Sending POST request to: ${API_BASE_URL}/jobs\n\n`;

            try {
                const response = await fetch(`${API_BASE_URL}/jobs`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testJobData)
                });

                message += `Response status: ${response.status} ${response.statusText}\n\n`;

                if (response.ok) {
                    const data = await response.json();
                    message += `‚úÖ SAVE SUCCESSFUL!\n\n`;
                    message += `Response data:\n${JSON.stringify(data, null, 2)}\n\n`;
                    message += `üéâ YOUR SAVE BUTTON SHOULD BE WORKING!\n\n`;
                    message += `If it's not working in your app, the issue is likely:\n`;
                    message += `- A JavaScript error in your browser (check console)\n`;
                    message += `- Form validation preventing submission\n`;
                    message += `- Browser cache (try hard refresh: Ctrl+Shift+R)\n\n`;
                    message += `Test cleanup: Deleting test job...`;
                    showResult(message, 'success');

                    // Clean up
                    try {
                        await fetch(`${API_BASE_URL}/jobs/${data.id || data.job?.id}`, {
                            method: 'DELETE'
                        });
                    } catch (e) {
                        console.log('Could not delete test job:', e);
                    }
                } else {
                    const errorData = await response.json();
                    message += `‚ùå SAVE FAILED!\n\n`;
                    message += `Error response:\n${JSON.stringify(errorData, null, 2)}\n\n`;
                    message += `THIS IS WHY YOUR SAVE BUTTON ISN'T WORKING!\n\n`;

                    if (response.status === 422 ||
                        errorData.message?.includes('field') ||
                        errorData.message?.includes('INVALID_VALUE_FOR_COLUMN')) {
                        message += `DIAGNOSIS: Missing Airtable fields\n\n`;
                        message += `SOLUTION:\n`;
                        message += `1. Run Test 2 to see which fields are missing\n`;
                        message += `2. Go to: https://airtable.com/appYjsKjwhJbkwFv5\n`;
                        message += `3. Add the missing fields\n`;
                        message += `4. Follow: AIRTABLE_FIELD_SETUP.md`;
                    } else if (response.status === 500) {
                        message += `DIAGNOSIS: Backend server error\n\n`;
                        message += `SOLUTION:\n`;
                        message += `Check Heroku logs for detailed error information.`;
                    } else {
                        message += `DIAGNOSIS: Unknown error\n\n`;
                        message += `Error message: ${errorData.message || errorData.error}`;
                    }

                    showResult(message, 'error');
                }

            } catch (error) {
                message += `‚ùå NETWORK ERROR\n\n`;
                message += `Error: ${error.message}\n\n`;
                message += `Could not connect to backend API.\n`;
                message += `Run Test 1 to check backend connectivity.`;
                showResult(message, 'error');
            }
        });

        // Test 4: Frontend Check
        document.getElementById('testFrontend').addEventListener('click', async () => {
            showResult('Checking frontend code...', 'info');

            let message = `üìù FRONTEND CODE CHECK\n\n`;

            try {
                // Check if main.js is accessible
                const mainJsResponse = await fetch('js/main.js');
                if (mainJsResponse.ok) {
                    message += `‚úì main.js file is accessible\n`;
                } else {
                    message += `‚úó main.js file returned status ${mainJsResponse.status}\n`;
                }

                // Check API URL configuration
                message += `\n`;
                message += `API Configuration:\n`;
                message += `  URL: ${API_BASE_URL}\n`;
                message += `\n`;

                // Check browser compatibility
                message += `Browser Information:\n`;
                message += `  User Agent: ${navigator.userAgent}\n`;
                message += `  Fetch API: ${typeof fetch !== 'undefined' ? '‚úì Supported' : '‚úó Not supported'}\n`;
                message += `  LocalStorage: ${typeof localStorage !== 'undefined' ? '‚úì Supported' : '‚úó Not supported'}\n`;
                message += `  Async/Await: ${typeof async !== 'undefined' ? '‚úì Supported' : '‚úó Not supported'}\n`;
                message += `\n`;

                message += `‚úÖ Frontend code structure looks correct.\n\n`;
                message += `If save button isn't working, check:\n`;
                message += `1. Browser console (F12) for JavaScript errors\n`;
                message += `2. Network tab to see if API calls are being made\n`;
                message += `3. Form validation (all required fields filled?)`;

                showResult(message, 'success');

            } catch (error) {
                message += `‚ùå Error checking frontend:\n`;
                message += `${error.message}\n\n`;
                message += `This might indicate a file loading issue.`;
                showResult(message, 'error');
            }
        });
    </script>
</body>
</html>
